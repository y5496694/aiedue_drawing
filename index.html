<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>에이두 스케치보드</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; overflow: hidden; }
        .tool-btn { display: flex; align-items: center; justify-content: center; width: 2.5rem; height: 2.5rem; }
        .tool-btn.active { background-color: #3b82f6; color: white; }
        .tool-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        #canvas-container { position: relative; width: 100%; height: 100%; cursor: none; }
        canvas { position: absolute; top: 0; left: 0; }
        #html-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        .text-box { position: absolute; border-radius: 8px; padding: 8px 12px; text-align: center; pointer-events: all; min-width: 50px; white-space: pre-wrap; word-break: break-word; }
        .text-box:focus-within { box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.4); }
        .text-box-content { outline: none; }
        .anchor-point { position: absolute; width: 10px; height: 10px; background-color: #3b82f6; border-radius: 50%; cursor: crosshair; pointer-events: all; transform: translate(-50%, -50%); }
        .anchor-point.n { top: 0; left: 50%; } .anchor-point.s { bottom: 0; left: 50%; } .anchor-point.w { top: 50%; left: 0; } .anchor-point.e { top: 50%; right: 0; }
        .resize-handle { position: absolute; width: 10px; height: 10px; background-color: #fff; border: 1px solid #3b82f6; pointer-events: all; }
        .resize-handle.nw { top: -5px; left: -5px; cursor: nwse-resize; } .resize-handle.ne { top: -5px; right: -5px; cursor: nesw-resize; } .resize-handle.sw { bottom: -5px; left: -5px; cursor: nesw-resize; } .resize-handle.se { bottom: -5px; right: -5px; cursor: nwse-resize; }
        #file-list li:hover { background-color: #f3f4f6; }
        .tool-separator { border-left: 1px solid #d1d5db; height: 2rem; margin: 0 0.5rem; }
        .embedded-iframe { width: 100%; height: 100%; border: none; border-radius: 8px; }
        .site-link-btn { position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.5); color: white; padding: 2px 5px; border-radius: 4px; font-size: 12px; text-decoration: none; pointer-events: all; }
    </style>
</head>
<body class="bg-gray-100 flex flex-col items-center justify-center h-screen p-4">

    <div class="w-full max-w-full h-full flex flex-col">
        <div class="flex flex-wrap justify-between items-center mb-4 gap-4 flex-shrink-0">
            <div class="flex items-center gap-4">
                <h1 class="text-2xl font-bold text-gray-800">에이두 스케치보드</h1>
                <input id="file-name-input" type="text" class="text-xl font-semibold border-2 border-transparent focus:border-blue-400 rounded-md px-2 py-1 transition hidden" value="제목 없는 보드">
            </div>
            <div id="auth-section" class="flex items-center gap-3">
                 <span id="user-info" class="text-gray-600 hidden"></span>
                 <button id="my-files-btn" class="bg-white hover:bg-gray-100 text-gray-800 font-semibold py-2 px-4 border border-gray-300 rounded-lg shadow-sm hidden"><i class="fas fa-folder-open mr-2"></i>내 파일</button>
                 <button id="save-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 hidden"><i class="fas fa-save mr-2"></i>저장</button>
                 <button id="logout-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 hidden"><i class="fas fa-sign-out-alt mr-2"></i>로그아웃</button>
            </div>
        </div>

        <div id="auth-forms" class="bg-white p-6 rounded-xl shadow-lg m-auto w-full max-w-md">
            <div id="login-form">
                <h2 class="text-2xl font-bold mb-4 text-center">로그인</h2>
                <input type="email" id="login-email" placeholder="이메일" class="w-full p-2 mb-3 border rounded-md">
                <input type="password" id="login-password" placeholder="비밀번호" class="w-full p-2 mb-4 border rounded-md">
                <button id="login-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg mb-2">로그인</button>
                <p class="mt-4 text-center">계정이 없으신가요? <button id="show-signup-btn" class="text-blue-500 hover:underline">회원가입</button></p>
            </div>
            <div id="signup-form" class="hidden">
                <h2 class="text-2xl font-bold mb-4 text-center">회원가입</h2>
                <input type="email" id="signup-email" placeholder="이메일" class="w-full p-2 mb-3 border rounded-md">
                <input type="password" id="signup-password" placeholder="비밀번호 (6자 이상)" class="w-full p-2 mb-4 border rounded-md">
                <button id="signup-btn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg">회원가입</button>
                <p class="mt-4 text-center">이미 계정이 있으신가요? <button id="show-login-btn" class="text-blue-500 hover:underline">로그인</button></p>
            </div>
        </div>

        <div id="main-content" class="flex-grow flex-col hidden">
            <div id="toolbar" class="bg-white p-2 rounded-xl shadow-lg mb-4 flex-wrap items-center justify-center gap-2 flex-shrink-0 flex">
                <button id="undo-btn" class="tool-btn"><i class="fas fa-undo"></i></button>
                <button id="redo-btn" class="tool-btn"><i class="fas fa-redo"></i></button>
                <div class="tool-separator"></div>
                <button data-tool="pan" class="tool-btn active"><i class="fas fa-hand-paper"></i></button>
                <div class="tool-separator"></div>
                <button data-tool="pen" class="tool-btn"><i class="fas fa-pencil-alt"></i></button>
                <button data-tool="eraser" class="tool-btn"><i class="fas fa-eraser"></i></button>
                <button data-tool="text" class="tool-btn"><i class="fas fa-font"></i></button>
                <div class="tool-separator"></div>
                <button data-tool="rect" class="tool-btn"><i class="far fa-square"></i></button>
                <button data-tool="circle" class="tool-btn"><i class="far fa-circle"></i></button>
                <button data-tool="line" class="tool-btn"><i class="fas fa-minus"></i></button>
                <div class="tool-separator"></div>
                <div class="flex items-center gap-2"><label class="font-semibold">색상:</label><input type="color" id="color-picker" value="#000000" class="w-10 h-10 rounded-md border-gray-300 cursor-pointer"></div>
                <div class="flex items-center gap-2"><label class="font-semibold">배경:</label><input type="color" id="bg-color-picker" value="#FFFFFF" class="w-10 h-10 rounded-md border-gray-300 cursor-pointer"></div>
                <div class="flex items-center gap-2"><label class="font-semibold">굵기:</label><input type="range" id="line-width" min="1" max="50" value="5" class="cursor-pointer"><span id="line-width-display" class="font-mono w-6 text-center">5</span></div>
                <button id="clear-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg shadow-md"><i class="fas fa-trash-alt mr-2"></i>전체 지우기</button>
            </div>
            <div id="canvas-container" class="flex-grow w-full rounded-xl shadow-2xl overflow-hidden">
                 <canvas id="sketch-canvas"></canvas>
                 <canvas id="cursor-canvas"></canvas>
                 <div id="html-overlay"></div>
            </div>
        </div>
    </div>
    
    <div id="alert-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50"><div class="bg-white p-6 rounded-lg shadow-xl text-center"><p id="alert-message" class="mb-4 text-lg"></p><button id="alert-ok-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-lg">확인</button></div></div>
    <div id="file-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50"><div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-lg"><h2 class="text-2xl font-bold mb-4">내 파일 목록</h2><ul id="file-list" class="max-h-96 overflow-y-auto mb-4 border rounded-md"></ul><div class="flex justify-between"><button id="new-board-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg"><i class="fas fa-plus mr-2"></i>새 보드</button><button id="close-file-modal-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">닫기</button></div></div></div>
    <div id="text-style-popover" class="fixed bg-white p-3 rounded-lg shadow-lg hidden flex-col gap-2 z-50">
        <div class="flex items-center gap-2"><label class="text-sm">배경:</label><input type="color" id="text-bg-color" value="#f3f4f6"></div>
        <div class="flex items-center gap-2"><label class="text-sm">테두리:</label><input type="color" id="text-border-color" value="#d1d5db"></div>
        <div class="flex justify-around mt-2">
            <button id="ai-generate-btn" class="hover:bg-gray-200 p-1 rounded"><i class="fas fa-magic-sparkles"></i> AI</button>
            <button id="embed-btn" class="hover:bg-gray-200 p-1 rounded"><i class="fas fa-code"></i> 임베드</button>
            <button id="delete-text-btn" class="text-red-500 hover:bg-red-100 p-1 rounded"><i class="fas fa-trash-alt"></i> 제거</button>
        </div>
    </div>
    <div id="prompt-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50"><div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md"><h2 class="text-xl font-bold mb-4">AI 글 생성</h2><textarea id="ai-prompt-input" class="w-full p-2 border rounded-md mb-4" rows="4" placeholder="생성할 내용의 주제나 키워드를 입력하세요..."></textarea><div class="flex justify-end gap-2"><button id="cancel-prompt-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">취소</button><button id="submit-prompt-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">생성</button></div></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
        import { getAuth, signOut, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, query, orderBy, getDocs, serverTimestamp, updateDoc, limit, deleteDoc } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyDCeJPDQUNi-KmJ9DhkTRIu-9t2PGZCpt0", authDomain: "mansungcoin-c6e06.firebaseapp.com", projectId: "mansungcoin-c6e06", storageBucket: "mansungcoin-c6e06.firebasestorage.app", messagingSenderId: "704809284946", appId: "1:704809284946:web:a7db6fa255da7e7ae1768b" };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let currentUser = null, currentSketchId = null;

        // --- UI Elements ---
        const ui = { authForms: document.getElementById('auth-forms'), mainContent: document.getElementById('main-content'), loginForm: document.getElementById('login-form'), signupForm: document.getElementById('signup-form'), showSignupBtn: document.getElementById('show-signup-btn'), showLoginBtn: document.getElementById('show-login-btn'), loginEmailInput: document.getElementById('login-email'), loginPasswordInput: document.getElementById('login-password'), loginBtn: document.getElementById('login-btn'), signupEmailInput: document.getElementById('signup-email'), signupPasswordInput: document.getElementById('signup-password'), signupBtn: document.getElementById('signup-btn'), canvas: document.getElementById('sketch-canvas'), ctx: document.getElementById('sketch-canvas').getContext('2d'), cursorCanvas: document.getElementById('cursor-canvas'), cursorCtx: document.getElementById('cursor-canvas').getContext('2d'), colorPicker: document.getElementById('color-picker'), bgColorPicker: document.getElementById('bg-color-picker'), lineWidth: document.getElementById('line-width'), lineWidthDisplay: document.getElementById('line-width-display'), saveBtn: document.getElementById('save-btn'), clearBtn: document.getElementById('clear-btn'), logoutBtn: document.getElementById('logout-btn'), userInfo: document.getElementById('user-info'), myFilesBtn: document.getElementById('my-files-btn'), fileModal: document.getElementById('file-modal'), fileList: document.getElementById('file-list'), newBoardBtn: document.getElementById('new-board-btn'), closeFileModalBtn: document.getElementById('close-file-modal-btn'), fileNameInput: document.getElementById('file-name-input'), toolbar: document.getElementById('toolbar'), htmlOverlay: document.getElementById('html-overlay'), textStylePopover: document.getElementById('text-style-popover'), alertModal: document.getElementById('alert-modal'), alertMessage: document.getElementById('alert-message'), alertOkBtn: document.getElementById('alert-ok-btn'), undoBtn: document.getElementById('undo-btn'), redoBtn: document.getElementById('redo-btn'), promptModal: document.getElementById('prompt-modal') };

        // --- State ---
        let history = [], historyPointer = -1, isDrawing = false, activeTool = 'pan', temporaryTool = null, viewTransform = { scale: 1, translateX: 0, translateY: 0 }, isPanning = false, panStart = { x: 0, y: 0 }, drawingStartPos = null, previewElement = null, selectedTextBox = null, isResizing = false, resizeHandle = null, isDragging = false, dragStart = {x:0, y:0};
        let mousePos = {x: 0, y: 0};
        
        // --- Alert & Init ---
        function showAlert(message) { ui.alertMessage.textContent = message; ui.alertModal.classList.remove('hidden'); }
        ui.alertOkBtn.addEventListener('click', () => ui.alertModal.classList.add('hidden'));
        window.addEventListener('resize', resizeCanvas);
        window.addEventListener('load', () => setTimeout(resizeCanvas, 100));

        // --- History (Undo/Redo) ---
        function saveHistoryState() { historyPointer++; history.splice(historyPointer); history.push(JSON.parse(JSON.stringify(ui.historyData))); updateUndoRedoButtons(); }
        function undo() { if (historyPointer > 0) { historyPointer--; ui.historyData = JSON.parse(JSON.stringify(history[historyPointer])); redrawAll(); updateUndoRedoButtons(); } }
        function redo() { if (historyPointer < history.length - 1) { historyPointer++; ui.historyData = JSON.parse(JSON.stringify(history[historyPointer])); redrawAll(); updateUndoRedoButtons(); } }
        function updateUndoRedoButtons() { ui.undoBtn.disabled = historyPointer <= 0; ui.redoBtn.disabled = historyPointer >= history.length - 1; }
        ui.undoBtn.addEventListener('click', undo);
        ui.redoBtn.addEventListener('click', redo);

        // --- Canvas & Drawing Logic ---
        function resizeCanvas() { const dpr = window.devicePixelRatio || 1, rect = ui.canvas.parentElement.getBoundingClientRect(); [ui.canvas, ui.cursorCanvas].forEach(c => { c.width = rect.width * dpr; c.height = rect.height * dpr; c.style.width = `${rect.width}px`; c.style.height = `${rect.height}px`; }); redrawAll(); }

        function redrawAll() {
            const dpr = window.devicePixelRatio || 1;
            ui.ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
            ui.ctx.fillStyle = ui.bgColorPicker.value;
            ui.ctx.fillRect(0, 0, ui.canvas.clientWidth, ui.canvas.clientHeight);
            ui.ctx.translate(viewTransform.translateX, viewTransform.translateY);
            ui.ctx.scale(viewTransform.scale, viewTransform.scale);
            
            const elementsToDraw = [...ui.historyData, previewElement].filter(el => el && el.tool);
            
            elementsToDraw.forEach(el => {
                if (el.type === 'text' || el.type === 'embed') return;
                ui.ctx.beginPath();
                ui.ctx.lineWidth = el.width;
                ui.ctx.strokeStyle = el.color;
                ui.ctx.lineCap = 'round'; ui.ctx.lineJoin = 'round';
                ui.ctx.globalCompositeOperation = 'source-over';

                switch (el.tool) {
                    case 'pen': if (el.points.length < 2) return; ui.ctx.moveTo(el.points[0].x, el.points[0].y); for (let i = 1; i < el.points.length; i++) ui.ctx.lineTo(el.points[i].x, el.points[i].y); break;
                    case 'eraser': if (el.points.length < 2) return; ui.ctx.strokeStyle = ui.bgColorPicker.value; ui.ctx.moveTo(el.points[0].x, el.points[0].y); for (let i = 1; i < el.points.length; i++) ui.ctx.lineTo(el.points[i].x, el.points[i].y); break;
                    case 'rect': ui.ctx.rect(el.x, el.y, el.w, el.h); break;
                    case 'circle': ui.ctx.arc(el.x + el.w / 2, el.y + el.h / 2, Math.max(Math.abs(el.w / 2), Math.abs(el.h / 2)), 0, 2 * Math.PI); break;
                    case 'line': ui.ctx.moveTo(el.x, el.y); ui.ctx.lineTo(el.x + el.w, el.y + el.h); break;
                    case 'arrow': drawArrow(el.from, el.to, el.color, el.width); break;
                }
                ui.ctx.stroke();
            });
            renderHtmlElements();
            drawCursor();
        }

        function drawArrow(from, to, color, width) { const headlen = 10; const angle = Math.atan2(to.y - from.y, to.x - from.x); ui.ctx.moveTo(from.x, from.y); ui.ctx.lineTo(to.x, to.y); ui.ctx.lineTo(to.x - headlen * Math.cos(angle - Math.PI / 6), to.y - headlen * Math.sin(angle - Math.PI / 6)); ui.ctx.moveTo(to.x, to.y); ui.ctx.lineTo(to.x - headlen * Math.cos(angle + Math.PI / 6), to.y - headlen * Math.sin(angle + Math.PI / 6)); }
        function getTransformedCoords(e) { const rect = ui.canvas.getBoundingClientRect(), clientX = e.touches ? e.touches[0].clientX : e.clientX, clientY = e.touches ? e.touches[0].clientY : e.clientY; const cssX = clientX - rect.left, cssY = clientY - rect.top; return { x: (cssX - viewTransform.translateX) / viewTransform.scale, y: (cssY - viewTransform.translateY) / viewTransform.scale }; }
        function startDrawing(e) { const currentTool = temporaryTool || activeTool; if (currentTool === 'pan') return; isDrawing = true; drawingStartPos = getTransformedCoords(e); const commonProps = { tool: currentTool, color: ui.colorPicker.value, width: parseInt(ui.lineWidth.value, 10) }; if (currentTool === 'pen' || currentTool === 'eraser') { ui.historyData.push({ ...commonProps, points: [drawingStartPos] }); } else if (currentTool === 'text') { /* Handled on stop */ } else { previewElement = { ...commonProps, x: drawingStartPos.x, y: drawingStartPos.y, w: 0, h: 0 }; } }
        function draw(e) { if (!isDrawing || !drawingStartPos) return; e.preventDefault(); const currentPos = getTransformedCoords(e); const currentTool = temporaryTool || activeTool; if (currentTool === 'pen' || currentTool === 'eraser') { ui.historyData[ui.historyData.length - 1].points.push(currentPos); } else if (previewElement) { previewElement.w = currentPos.x - drawingStartPos.x; previewElement.h = currentPos.y - drawingStartPos.y; } redrawAll(); }
        function stopDrawing(e) { if (!isDrawing) return; isDrawing = false; const currentTool = temporaryTool || activeTool; if (previewElement) { ui.historyData.push(previewElement); previewElement = null; saveHistoryState(); } else if (currentTool === 'text') { const finalPos = getTransformedCoords(e); const id = `text_${Date.now()}`; const width = Math.abs(finalPos.x - drawingStartPos.x); const height = Math.abs(finalPos.y - drawingStartPos.y); const finalWidth = width < 10 ? 150 : width; const finalHeight = height < 10 ? 50 : height; const x = Math.min(drawingStartPos.x, finalPos.x); const y = Math.min(drawingStartPos.y, finalPos.y); ui.historyData.push({ type: 'text', tool: 'text', id, content: '텍스트', x, y, width: finalWidth, height: finalHeight, bgColor: 'rgba(243, 244, 246, 0.8)', borderColor: 'rgba(209, 213, 219, 0.5)' }); saveHistoryState(); } else if (currentTool === 'pen' || currentTool === 'eraser') { saveHistoryState(); } redrawAll(); }

        // --- Pan, Zoom, Cursor ---
        function setCursorForTool(tool) { const currentTool = temporaryTool || tool; if (currentTool === 'pan') { ui.canvas.parentElement.style.cursor = isPanning ? 'grabbing' : 'grab'; } else { ui.canvas.parentElement.style.cursor = 'none'; } }
        function drawCursor() {
            const dpr = window.devicePixelRatio || 1;
            ui.cursorCtx.setTransform(dpr, 0, 0, dpr, 0, 0);
            ui.cursorCtx.clearRect(0, 0, ui.cursorCanvas.clientWidth, ui.cursorCanvas.clientHeight);
            const currentTool = temporaryTool || activeTool;
            const iconMap = { pen: '\uf304', text: '\uf031', rect: '\uf0c8', circle: '\uf111', line: '\uf068', arrow: '\uf061' };
            
            ui.cursorCtx.save();
            ui.cursorCtx.translate(mousePos.x, mousePos.y);
            
            if (currentTool === 'eraser') {
                const radius = (parseInt(ui.lineWidth.value, 10) / 2) * viewTransform.scale;
                ui.cursorCtx.beginPath();
                ui.cursorCtx.arc(0, 0, radius, 0, 2 * Math.PI);
                ui.cursorCtx.strokeStyle = '#555';
                ui.cursorCtx.fillStyle = 'rgba(180, 180, 180, 0.5)';
                ui.cursorCtx.stroke();
                ui.cursorCtx.fill();
            } else if (iconMap[currentTool]) {
                 ui.cursorCtx.font = "20px 'Font Awesome 6 Free'";
                 ui.cursorCtx.fillStyle = ui.colorPicker.value;
                 ui.cursorCtx.fillText(iconMap[currentTool], 15, 15);
            } else if (currentTool === 'pan') {
                 ui.cursorCtx.font = "24px 'Font Awesome 6 Free'";
                 ui.cursorCtx.strokeStyle = 'black';
                 ui.cursorCtx.lineWidth = 2;
                 ui.cursorCtx.strokeText(isPanning ? '\uf256' : '\uf255', -8, 8);
                 ui.cursorCtx.fillStyle = 'white';
                 ui.cursorCtx.fillText(isPanning ? '\uf256' : '\uf255', -8, 8);
            }
            ui.cursorCtx.restore();
        }
        window.addEventListener('keydown', (e) => { if (e.repeat) return; if (e.key === ' ') { temporaryTool = 'pen'; } else if (e.key === 'Shift') { temporaryTool = 'eraser'; } else if (e.ctrlKey && e.key === 'z') { undo(); } else if (e.ctrlKey && e.key === 's') { e.preventDefault(); saveDrawing(); } if (e.key === 'Delete' && selectedTextBox) { ui.historyData = ui.historyData.filter(el => el.id !== selectedTextBox.id); saveHistoryState(); redrawAll(); } setCursorForTool(activeTool); });
        window.addEventListener('keyup', (e) => { if (e.key === ' ' || e.key === 'Shift') { temporaryTool = null; } setCursorForTool(activeTool); });
        ui.canvas.parentElement.addEventListener('wheel', (e) => { if (e.ctrlKey) { e.preventDefault(); const scaleAmount = -e.deltaY > 0 ? 1.1 : 1 / 1.1; viewTransform.scale *= scaleAmount; viewTransform.translateX = viewTransform.translateX * scaleAmount + (e.clientX - ui.canvas.getBoundingClientRect().left) * (1 - scaleAmount); viewTransform.translateY = viewTransform.translateY * scaleAmount + (e.clientY - ui.canvas.getBoundingClientRect().top) * (1 - scaleAmount); redrawAll(); } });
        ui.canvas.parentElement.addEventListener('mousedown', (e) => { const currentTool = temporaryTool || activeTool; if (currentTool === 'pan' && e.target.closest('.text-box') === null) { isPanning = true; panStart = { x: e.clientX, y: e.clientY }; } else { startDrawing(e); } setCursorForTool(activeTool); });
        ui.canvas.parentElement.addEventListener('mousemove', (e) => { const rect = ui.canvas.getBoundingClientRect(); mousePos = {x: e.clientX - rect.left, y: e.clientY - rect.top}; if (isPanning) { const dx = e.clientX - panStart.x, dy = e.clientY - panStart.y; viewTransform.translateX += dx; viewTransform.translateY += dy; panStart = { x: e.clientX, y: e.clientY }; redrawAll(); } else if (isResizing) { handleResize(e); } else if (isDragging) { handleDrag(e); } else { draw(e); } drawCursor(); });
        ui.canvas.parentElement.addEventListener('mouseup', (e) => { isPanning = false; isDragging = false; isResizing = false; if (!isResizing && !isDragging) selectedTextBox = null; setCursorForTool(activeTool); stopDrawing(e); });
        ui.canvas.parentElement.addEventListener('mouseout', stopDrawing);

        // --- Toolbar & Auth Listeners ---
        ui.lineWidth.addEventListener('input', (e) => { ui.lineWidthDisplay.textContent = e.target.value; });
        ui.bgColorPicker.addEventListener('input', () => { saveHistoryState(); redrawAll(); });
        ui.toolbar.addEventListener('click', (e) => { const btn = e.target.closest('.tool-btn'); if (!btn) return; activeTool = btn.dataset.tool; ui.toolbar.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); setCursorForTool(activeTool); });
        ui.clearBtn.addEventListener('click', () => { ui.historyData = []; saveHistoryState(); redrawAll(); });
        ui.showSignupBtn.addEventListener('click', () => { ui.loginForm.classList.add('hidden'); ui.signupForm.classList.remove('hidden'); });
        ui.showLoginBtn.addEventListener('click', () => { ui.signupForm.classList.add('hidden'); ui.loginForm.classList.remove('hidden'); });
        ui.signupBtn.addEventListener('click', () => createUserWithEmailAndPassword(auth, ui.signupEmailInput.value, ui.signupPasswordInput.value).catch(handleAuthError));
        ui.loginBtn.addEventListener('click', () => signInWithEmailAndPassword(auth, ui.loginEmailInput.value, ui.loginPasswordInput.value).catch(handleAuthError));
        ui.logoutBtn.addEventListener('click', () => signOut(auth));
        
        // --- Auth State & Error Handling ---
        onAuthStateChanged(auth, async (user) => { currentUser = user; if (user) { ui.userInfo.textContent = `${user.email || user.displayName}님`; [ui.userInfo, ui.logoutBtn, ui.saveBtn, ui.myFilesBtn, ui.mainContent, ui.fileNameInput].forEach(el => el.classList.remove('hidden')); ui.mainContent.classList.add('flex'); ui.authForms.classList.add('hidden'); setTimeout(resizeCanvas, 0); await loadMostRecentBoard(); } else { [ui.userInfo, ui.logoutBtn, ui.saveBtn, ui.myFilesBtn, ui.mainContent, ui.fileNameInput].forEach(el => el.classList.add('hidden')); ui.mainContent.classList.remove('flex'); ui.authForms.classList.remove('hidden'); currentSketchId = null; history = []; } });
        function handleAuthError(error) { switch (error.code) { case 'auth/wrong-password': case 'auth/user-not-found': case 'auth/invalid-credential': showAlert('이메일 또는 비밀번호가 올바르지 않습니다.'); break; case 'auth/email-already-in-use': showAlert('이미 사용 중인 이메일입니다.'); break; case 'auth/invalid-email': showAlert('유효하지 않은 이메일 주소입니다.'); break; case 'auth/weak-password': showAlert('비밀번호는 6자 이상이어야 합니다.'); break; default: showAlert(`오류가 발생했습니다: ${error.message}`); } }
        function handleFirestoreError(error, context) { console.error(`${context} 실패:`, error); if (error.code === 'permission-denied') { showAlert('권한이 없습니다. Firebase 보안 규칙을 확인해주세요.'); } else { showAlert(`${context === 'save' ? '저장' : '로드'} 중 오류가 발생했습니다.`); } }

        // --- Text Box and Arrow Logic ---
        ui.canvas.parentElement.addEventListener('dblclick', (e) => { const currentTool = temporaryTool || activeTool; if (currentTool !== 'pan') return; if (e.target.closest('.text-box')) return; const coords = getTransformedCoords(e); const id = `text_${Date.now()}`; ui.historyData.push({ type: 'text', tool: 'text', id, content: '텍스트', x: coords.x - 75, y: coords.y - 25, width: 150, height: 50, bgColor: 'rgba(243, 244, 246, 0.8)', borderColor: 'rgba(209, 213, 219, 0.5)' }); saveHistoryState(); redrawAll(); });
        function renderHtmlElements() {
            ui.htmlOverlay.innerHTML = '';
            ui.historyData.filter(el => el.type === 'text' || el.type === 'embed').forEach(el => {
                const div = document.createElement('div');
                div.className = 'text-box';
                div.id = el.id;
                const left = el.x * viewTransform.scale + viewTransform.translateX;
                const top = el.y * viewTransform.scale + viewTransform.translateY;
                div.style.transform = `translate(${left}px, ${top}px)`;
                div.style.width = `${el.width * viewTransform.scale}px`;
                div.style.minHeight = `${el.height * viewTransform.scale}px`;
                div.style.fontSize = `${16 * viewTransform.scale}px`;
                div.style.backgroundColor = el.bgColor || 'rgba(243, 244, 246, 0.8)';
                div.style.borderColor = el.borderColor || 'rgba(209, 213, 219, 0.5)';
                
                if (el.type === 'embed') {
                    div.innerHTML = el.embedCode;
                    const iframe = div.querySelector('iframe');
                    if (iframe) {
                        iframe.style.width = '100%';
                        iframe.style.height = `${el.height * viewTransform.scale}px`;
                    }
                    const link = document.createElement('a');
                    link.href = iframe ? iframe.src : '#';
                    link.target = '_blank';
                    link.className = 'site-link-btn';
                    link.innerHTML = '<i class="fas fa-external-link-alt"></i>';
                    div.appendChild(link);
                } else {
                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'text-box-content';
                    contentDiv.innerText = el.content;
                    div.appendChild(contentDiv);
                    contentDiv.addEventListener('dblclick', (e) => { e.stopPropagation(); contentDiv.contentEditable = true; contentDiv.focus(); ui.textStylePopover.classList.add('hidden'); });
                    contentDiv.addEventListener('blur', () => { contentDiv.contentEditable = false; saveHistoryState(); });
                    contentDiv.addEventListener('input', () => { el.content = contentDiv.innerText; const tempSpan = document.createElement('span'); tempSpan.style.whiteSpace = 'pre-wrap'; tempSpan.style.wordBreak = 'break-word'; tempSpan.style.padding = '8px 12px'; tempSpan.style.fontSize = `${16 * viewTransform.scale}px`; tempSpan.style.width = `${el.width * viewTransform.scale}px`; tempSpan.innerText = contentDiv.innerText; document.body.appendChild(tempSpan); el.height = tempSpan.clientHeight / viewTransform.scale; document.body.removeChild(tempSpan); redrawAll(); });
                }
                
                div.addEventListener('mousedown', (e) => { e.stopPropagation(); selectedTextBox = el; isDragging = true; const coords = getTransformedCoords(e); dragStart = {x: coords.x - el.x, y: coords.y - el.y}; showTextStylePopover(e.clientX, e.clientY, el); });
                
                ['n', 's', 'e', 'w'].forEach(dir => { const anchor = document.createElement('div'); anchor.className = `anchor-point ${dir}`; anchor.dataset.parentId = el.id; anchor.dataset.dir = dir; anchor.addEventListener('mousedown', startArrowDrawing); div.appendChild(anchor); });
                ['nw', 'ne', 'sw', 'se'].forEach(dir => { const handle = document.createElement('div'); handle.className = `resize-handle ${dir}`; handle.dataset.dir = dir; handle.addEventListener('mousedown', (e) => { e.stopPropagation(); isResizing = true; resizeHandle = dir; selectedTextBox = el; dragStart = getTransformedCoords(e); }); div.appendChild(handle); });
                ui.htmlOverlay.appendChild(div);
            });
        }
        function showTextStylePopover(x, y, el) {
            ui.textStylePopover.classList.remove('hidden');
            ui.textStylePopover.style.left = `${x + 10}px`;
            ui.textStylePopover.style.top = `${y + 10}px`;
            const hexToRgba = (hex, alpha) => `rgba(${parseInt(hex.slice(1, 3), 16)}, ${parseInt(hex.slice(3, 5), 16)}, ${parseInt(hex.slice(5, 7), 16)}, ${alpha})`;
            document.getElementById('text-bg-color').oninput = (e) => { el.bgColor = hexToRgba(e.target.value, 0.8); redrawAll(); };
            document.getElementById('text-border-color').oninput = (e) => { el.borderColor = hexToRgba(e.target.value, 0.5); redrawAll(); };
        }
        document.addEventListener('mousedown', (e) => { if (!e.target.closest('.text-box') && !e.target.closest('#text-style-popover')) ui.textStylePopover.classList.add('hidden'); });
        function handleDrag(e) { if (!isDragging || !selectedTextBox) return; const coords = getTransformedCoords(e); selectedTextBox.x = coords.x - dragStart.x; selectedTextBox.y = coords.y - dragStart.y; redrawAll(); }
        function handleResize(e) { if (!isResizing || !selectedTextBox) return; const coords = getTransformedCoords(e); const dx = coords.x - dragStart.x; const dy = coords.y - dragStart.y; if (resizeHandle.includes('w')) { selectedTextBox.x += dx; selectedTextBox.width -= dx; } if (resizeHandle.includes('n')) { selectedTextBox.y += dy; selectedTextBox.height -= dy; } if (resizeHandle.includes('e')) { selectedTextBox.width += dx; } if (resizeHandle.includes('s')) { selectedTextBox.height += dy; } dragStart = coords; redrawAll(); }
        function startArrowDrawing(e) { e.stopPropagation(); isDrawing = true; const parentId = e.target.dataset.parentId; const dir = e.target.dataset.dir; const from = getAnchorPosition(parentId, dir); previewElement = { tool: 'arrow', from, to: from, color: '#a0a0a0', width: 5 }; ui.canvas.parentElement.addEventListener('mousemove', drawArrowPreview); ui.canvas.parentElement.addEventListener('mouseup', stopArrowDrawing, { once: true }); }
        function drawArrowPreview(e) { if (!previewElement) return; previewElement.to = getTransformedCoords(e); redrawAll(); }
        function stopArrowDrawing() { ui.canvas.parentElement.removeEventListener('mousemove', drawArrowPreview); isDrawing = false; if (previewElement) { ui.historyData.push(previewElement); previewElement = null; saveHistoryState(); } redrawAll(); }
        function getAnchorPosition(elementId, dir) { const el = ui.historyData.find(item => item.id === elementId); if (!el) return {x:0, y:0}; switch(dir) { case 'n': return {x: el.x + el.width/2, y: el.y}; case 's': return {x: el.x + el.width/2, y: el.y + el.height}; case 'w': return {x: el.x, y: el.y + el.height/2}; case 'e': return {x: el.x + el.width, y: el.y + el.height/2}; } }
        
        // --- Popover Actions ---
        document.getElementById('delete-text-btn').addEventListener('click', () => { if(selectedTextBox) { ui.historyData = ui.historyData.filter(el => el.id !== selectedTextBox.id); saveHistoryState(); redrawAll(); ui.textStylePopover.classList.add('hidden'); } });
        document.getElementById('embed-btn').addEventListener('click', () => { if(selectedTextBox) { const code = prompt('임베드할 HTML 코드를 입력하세요 (예: <iframe>...</iframe>)'); if (code) { selectedTextBox.type = 'embed'; selectedTextBox.embedCode = code; saveHistoryState(); redrawAll(); } ui.textStylePopover.classList.add('hidden'); } });
        document.getElementById('ai-generate-btn').addEventListener('click', () => { if(selectedTextBox) { ui.promptModal.classList.remove('hidden'); ui.textStylePopover.classList.add('hidden'); } });
        document.getElementById('cancel-prompt-btn').addEventListener('click', () => ui.promptModal.classList.add('hidden'));
        document.getElementById('submit-prompt-btn').addEventListener('click', async () => {
            const prompt = document.getElementById('ai-prompt-input').value;
            if (!prompt || !selectedTextBox) return;
            const btn = document.getElementById('submit-prompt-btn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 생성 중...';
            try {
                const apiKey = "AIzaSyC7_Gq4LIVVMv0hMD6qSwcTlGJcDSt-KgI";
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                if (!response.ok) throw new Error(`API 오류: ${response.statusText}`);
                const result = await response.json();
                const text = result.candidates[0].content.parts[0].text;
                selectedTextBox.content = text;
                saveHistoryState();
                redrawAll();
            } catch (error) {
                showAlert(`AI 생성 실패: ${error.message}`);
                console.error(error);
            } finally {
                ui.promptModal.classList.add('hidden');
                btn.disabled = false;
                btn.innerText = '생성';
            }
        });

        // --- File Management & Firestore ---
        async function saveDrawing() { if (!currentUser) { showAlert("로그인이 필요합니다."); return; } ui.saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>저장 중...'; ui.saveBtn.disabled = true; const data = { name: ui.fileNameInput.value || '제목 없는 보드', history: ui.historyData, viewTransform: viewTransform, updatedAt: serverTimestamp(), backgroundColor: ui.bgColorPicker.value }; try { let docRef; if (currentSketchId) { docRef = doc(db, 'users', currentUser.uid, 'sketches', currentSketchId); await updateDoc(docRef, data); } else { const collectionRef = collection(db, 'users', currentUser.uid, 'sketches'); docRef = await addDoc(collectionRef, data); currentSketchId = docRef.id; } showAlert("성공적으로 저장되었습니다!"); } catch (error) { handleFirestoreError(error, 'save'); } finally { ui.saveBtn.innerHTML = '<i class="fas fa-save mr-2"></i>저장'; ui.saveBtn.disabled = false; } }
        async function loadBoard(sketchId) { if (!currentUser) return; try { const sketchRef = doc(db, 'users', currentUser.uid, 'sketches', sketchId); const docSnap = await getDoc(sketchRef); if (docSnap.exists()) { const data = docSnap.data(); ui.historyData = data.history || []; history = [JSON.parse(JSON.stringify(ui.historyData))]; historyPointer = 0; viewTransform = data.viewTransform || { scale: 1, translateX: 0, translateY: 0 }; ui.bgColorPicker.value = data.backgroundColor || '#FFFFFF'; currentSketchId = docSnap.id; ui.fileNameInput.value = data.name || '제목 없는 보드'; redrawAll(); updateUndoRedoButtons(); ui.fileModal.classList.add('hidden'); } } catch (error) { handleFirestoreError(error, 'load'); } }
        async function loadMostRecentBoard() { const sketchesRef = collection(db, 'users', currentUser.uid, 'sketches'); const q = query(sketchesRef, orderBy("updatedAt", "desc"), limit(1)); const querySnapshot = await getDocs(q); if (!querySnapshot.empty) { await loadBoard(querySnapshot.docs[0].id); } else { createNewBoard(); } }
        function createNewBoard() { currentSketchId = null; ui.historyData = []; history = [[]]; historyPointer = 0; viewTransform = { scale: 1, translateX: 0, translateY: 0 }; ui.fileNameInput.value = `새 보드 ${new Date().toLocaleDateString()}`; ui.bgColorPicker.value = '#FFFFFF'; redrawAll(); updateUndoRedoButtons(); ui.fileModal.classList.add('hidden'); }
        ui.myFilesBtn.addEventListener('click', async () => { if (!currentUser) return; const sketchesRef = collection(db, 'users', currentUser.uid, 'sketches'); const q = query(sketchesRef, orderBy("updatedAt", "desc")); const querySnapshot = await getDocs(q); ui.fileList.innerHTML = ''; if (querySnapshot.empty) { ui.fileList.innerHTML = '<li class="p-4 text-center text-gray-500">저장된 파일이 없습니다.</li>'; } else { querySnapshot.forEach((doc) => { const li = document.createElement('li'); li.className = 'p-4 border-b cursor-pointer flex justify-between items-center'; li.innerHTML = `<span>${doc.data().name || '이름 없는 보드'}</span><button data-id="${doc.id}" class="delete-btn text-red-500 hover:text-red-700 text-xs p-1">삭제</button>`; li.querySelector('span').onclick = () => loadBoard(doc.id); ui.fileList.appendChild(li); }); } ui.fileModal.classList.remove('hidden'); });
        ui.fileList.addEventListener('click', async (e) => { if (e.target.classList.contains('delete-btn')) { const sketchId = e.target.dataset.id; if (confirm('정말로 이 보드를 삭제하시겠습니까?')) { try { await deleteDoc(doc(db, 'users', currentUser.uid, 'sketches', sketchId)); showAlert('보드가 삭제되었습니다.'); await ui.myFilesBtn.click(); if (currentSketchId === sketchId) createNewBoard(); } catch (error) { handleFirestoreError(error, 'delete'); } } } });
        ui.newBoardBtn.addEventListener('click', createNewBoard);
        ui.closeFileModalBtn.addEventListener('click', () => ui.fileModal.classList.add('hidden'));
        ui.saveBtn.addEventListener('click', saveDrawing);

        // This is a proxy to make history management easier
        ui.historyData = [];

    </script>
</body>
</html>
